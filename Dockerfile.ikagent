FROM nixos/nix:latest

# Configure Nix for flakes
COPY nix.conf /etc/nix/nix.conf

# Copy package list
COPY packages.nix /etc/ikagent/

# Remove conflicting packages from base image
RUN nix-env -e git-minimal || true

# Install packages directly with nix-env (no home-manager needed)
RUN nix-env -iA nixpkgs.zsh nixpkgs.git \
    nixpkgs.findutils nixpkgs.gnugrep nixpkgs.gnused nixpkgs.gawk nixpkgs.diffutils \
    nixpkgs.curl nixpkgs.wget nixpkgs.jq nixpkgs.tree nixpkgs.less nixpkgs.vim \
    nixpkgs.ripgrep nixpkgs.fd \
    nixpkgs.gnumake nixpkgs.gcc nixpkgs.pkg-config

# Install project-specific packages from packages.nix
RUN nix-env -if /etc/ikagent/packages.nix

# Set shell
ENV SHELL=/root/.nix-profile/bin/zsh

WORKDIR /workspace

CMD ["zsh", "-l"]
