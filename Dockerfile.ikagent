FROM nixos/nix:latest

COPY nix.conf /etc/nix/nix.conf

# Shell experience â€” not project tools, so install at image level
RUN nix-env -iA nixpkgs.zsh nixpkgs.starship
RUN echo 'eval "$(starship init zsh)"' >> /root/.zshrc

# Copy project flake and pre-build devShell so nix develop is instant at attach time
COPY flake.nix flake.lock /flake/

ARG TARGETARCH
RUN case "$TARGETARCH" in \
      amd64) echo "x86_64-linux" ;; \
      arm64) echo "aarch64-linux" ;; \
      *) echo "Unsupported architecture: $TARGETARCH" >&2 && exit 1 ;; \
    esac > /flake/system

RUN --mount=type=cache,target=/root/.cache/nix \
    nix build "/flake#devShells.$(cat /flake/system).default" --out-link /flake/dev-shell

WORKDIR /workspace

CMD ["sleep", "infinity"]
